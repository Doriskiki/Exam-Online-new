<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººè„¸è¯†åˆ«æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 32px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .video-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        video {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
        
        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status.online {
            background: #d4edda;
            color: #155724;
        }
        
        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ äººè„¸è¯†åˆ«æµ‹è¯•ç³»ç»Ÿ</h1>
        
        <div id="serviceStatus" class="status offline">
            æœåŠ¡çŠ¶æ€: æ£€æŸ¥ä¸­...
        </div>
        
        <!-- æ‘„åƒå¤´åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“¹ æ‘„åƒå¤´</h2>
            <div class="video-container">
                <video id="video" autoplay></video>
            </div>
            <div class="controls">
                <button class="btn-primary" onclick="startCamera()">æ‰“å¼€æ‘„åƒå¤´</button>
                <button class="btn-danger" onclick="stopCamera()">å…³é—­æ‘„åƒå¤´</button>
            </div>
        </div>
        
        <!-- äººè„¸æ£€æµ‹ -->
        <div class="section">
            <h2>ğŸ” äººè„¸æ£€æµ‹</h2>
            <div class="controls">
                <button class="btn-primary" onclick="detectFace()">æ£€æµ‹äººè„¸</button>
            </div>
            <div id="detectResult"></div>
        </div>
        
        <!-- äººè„¸æ³¨å†Œ -->
        <div class="section">
            <h2>ğŸ“ äººè„¸æ³¨å†Œ</h2>
            <div class="input-group">
                <label>ç”¨æˆ·ID:</label>
                <input type="text" id="registerUserId" placeholder="ä¾‹å¦‚: 123" value="123">
            </div>
            <div class="input-group">
                <label>ç”¨æˆ·å:</label>
                <input type="text" id="registerUserName" placeholder="ä¾‹å¦‚: å¼ ä¸‰" value="å¼ ä¸‰">
            </div>
            <div class="controls">
                <button class="btn-success" onclick="registerFace()">æ³¨å†Œäººè„¸</button>
            </div>
            <div id="registerResult"></div>
        </div>
        
        <!-- äººè„¸è¯†åˆ« -->
        <div class="section">
            <h2>ğŸ¯ äººè„¸è¯†åˆ«</h2>
            <div class="input-group">
                <label>ç›¸ä¼¼åº¦é˜ˆå€¼ (0-1):</label>
                <input type="number" id="threshold" min="0" max="1" step="0.1" value="0.5">
            </div>
            <div class="controls">
                <button class="btn-primary" onclick="recognizeFace()">è¯†åˆ«äººè„¸</button>
            </div>
            <div id="recognizeResult"></div>
        </div>
    </div>

    <script>
        // å¦‚æœè¦æµ‹è¯•PythonæœåŠ¡ï¼Œä½¿ç”¨ http://localhost:5000
        // å¦‚æœè¦æµ‹è¯•Javaåç«¯ï¼Œä½¿ç”¨ http://localhost:8888
        const API_BASE = 'http://localhost:5000';  // Pythonå¾®æœåŠ¡åœ°å€
        let video = document.getElementById('video');
        let stream = null;

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServiceStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                if (data.status === 'ok') {
                    document.getElementById('serviceStatus').className = 'status online';
                    document.getElementById('serviceStatus').textContent = 'æœåŠ¡çŠ¶æ€: âœ… åœ¨çº¿';
                } else {
                    throw new Error('æœåŠ¡å¼‚å¸¸');
                }
            } catch (error) {
                document.getElementById('serviceStatus').className = 'status offline';
                document.getElementById('serviceStatus').textContent = 'æœåŠ¡çŠ¶æ€: âŒ ç¦»çº¿';
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
                showResult('detectResult', 'æ‘„åƒå¤´å·²å¯åŠ¨', 'success');
            } catch (error) {
                showResult('detectResult', 'æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message, 'error');
            }
        }

        // å…³é—­æ‘„åƒå¤´
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                showResult('detectResult', 'æ‘„åƒå¤´å·²å…³é—­', 'info');
            }
        }

        // æ•è·å½“å‰å¸§
        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = typeof message === 'object' ? 
                JSON.stringify(message, null, 2) : message;
        }

        // äººè„¸æ£€æµ‹
        async function detectFace() {
            try {
                const imageBase64 = captureFrame();
                showResult('detectResult', 'æ­£åœ¨æ£€æµ‹...', 'info');
                
                const response = await fetch(`${API_BASE}/api/face/detect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageBase64 })
                });
                
                const result = await response.json();
                if (result.success) {
                    showResult('detectResult', 
                        `æ£€æµ‹æˆåŠŸï¼\næ£€æµ‹åˆ° ${result.count} å¼ äººè„¸\nè¯¦ç»†ä¿¡æ¯: ${JSON.stringify(result, null, 2)}`, 
                        'success');
                } else {
                    showResult('detectResult', 'æ£€æµ‹å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('detectResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äººè„¸æ³¨å†Œ
        async function registerFace() {
            try {
                const userId = document.getElementById('registerUserId').value;
                const userName = document.getElementById('registerUserName').value;
                
                if (!userId || !userName) {
                    showResult('registerResult', 'è¯·å¡«å†™ç”¨æˆ·IDå’Œç”¨æˆ·å', 'error');
                    return;
                }
                
                const imageBase64 = captureFrame();
                showResult('registerResult', 'æ­£åœ¨æ³¨å†Œ...', 'info');
                
                const response = await fetch(`${API_BASE}/api/face/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: userId,
                        userName: userName,
                        image: imageBase64 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showResult('registerResult', 
                        `æ³¨å†ŒæˆåŠŸï¼\nç”¨æˆ·: ${result.userName} (ID: ${result.userId})`, 
                        'success');
                } else {
                    showResult('registerResult', 'æ³¨å†Œå¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('registerResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äººè„¸è¯†åˆ«
        async function recognizeFace() {
            try {
                const threshold = parseFloat(document.getElementById('threshold').value);
                const imageBase64 = captureFrame();
                showResult('recognizeResult', 'æ­£åœ¨è¯†åˆ«...', 'info');
                
                const response = await fetch(`${API_BASE}/api/face/recognize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: imageBase64,
                        threshold: threshold
                    })
                });
                
                const result = await response.json();
                if (result.success && result.matched) {
                    showResult('recognizeResult', 
                        `è¯†åˆ«æˆåŠŸï¼\nç”¨æˆ·: ${result.userName} (ID: ${result.userId})\nç›¸ä¼¼åº¦: ${(result.similarity * 100).toFixed(2)}%`, 
                        'success');
                } else if (result.success) {
                    showResult('recognizeResult', 
                        `æœªæ‰¾åˆ°åŒ¹é…çš„äººè„¸\næœ€é«˜ç›¸ä¼¼åº¦: ${(result.similarity * 100).toFixed(2)}%`, 
                        'info');
                } else {
                    showResult('recognizeResult', 'è¯†åˆ«å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showResult('recognizeResult', 'è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        checkServiceStatus();
        setInterval(checkServiceStatus, 5000);  // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>
